#!upstart
description "Properly handle haproxy"

start on (local-filesystems and net-device-up IFACE=eth0)
stop on shutdown
#start on startup

respawn # restart when job dies
respawn limit 2 5 # give up restart after 2 respawns in 5 seconds

env PID_PATH=/var/run/haproxy.pid
env BIN_PATH=/usr/sbin/haproxy

script
exec /bin/bash <<EOF
  $BIN_PATH -f /etc/haproxy/haproxy.cfg -D -p $PID_PATH

  trap "$BIN_PATH -f /etc/haproxy/haproxy.cfg -p $PID_PATH -sf \\\$(cat $PID_PATH)" SIGHUP
  trap "kill -TERM \\\$(cat $PID_PATH) && exit 0" SIGTERM SIGINT

  while true; do # Iterate to keep job running.
    sleep 1 # Don't sleep to long as signals will not be handled during sleep.
  done
EOF
end script
